<html>
<head>
    <link rel="shortcut icon" href="img/isbfavicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" type="text/css"
          href="https://informatics-apps.systemsbiology.net/bootstrap-2.0.4/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css"
          href="https://informatics-apps.systemsbiology.net/jquery-ui-1.10.2.custom/css/smoothness/jquery-ui-1.10.2.custom.min.css"/>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Heatmap</title>

    <meta name="viewport" content="width=device-width">

    <script type="text/javascript" src="http://informatics-apps.systemsbiology.net/jquery-1.9.1/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="http://informatics-apps.systemsbiology.net/jquery-ui-1.10.2.custom/js/jquery-ui-1.10.2.custom.min.js"></script>
    <script type="text/javascript" src="http://informatics-apps.systemsbiology.net/d3js-3.1.4/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://informatics-apps.systemsbiology.net/bootstrap-2.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://informatics-apps.systemsbiology.net/underscore/underscore-min.js"></script>

    <script type="text/javascript" src="js/stacksvis.js"></script>

    <link rel="stylesheet" type="text/css" href="css/stacksvis.css"/>

    <script type="text/javascript">
        $(document).ready(function () {
            stacksvis = new Stacksvis($(".vis"), {
                "selectors": {
                    "row": "span2 nav s-row",
                    "column": "nav nav-pills s-column",
                    "cluster": "offset4 nav nav-pills s-cluster",
                    "heatmap": "span9 s-heatmap"
                },
                "colorscales": {
                    "Row_3": ["lightblue", "blue"]
                }
            });
            $(".vis").on("render-dimensions", enableDraggable);

            activateVisControls();
            loadTestData();
            drawHeatmap();
        });

        drawHeatmap = function () {
            var txt = $("#text_data").val();
            var rows = d3.csv.parseRows(txt);
            var data = _.map(rows, function (row) {
                return _.map(row, parseFloat);
            });

            var rowlabels = _.map(_.range(0, rows.length), function (i) {
                return "Row_" + i;
            });

            var columnlabels = _.map(_.range(0, _.first(rows).length), function (i) {
                return "Col_" + i;
            });

            rowlabels.push("EVEN_or_ODD");
            data.push(_.map(columnlabels, function (label, idx) {
                return (idx % 2 == 0) ? "EVEN" : "ODD";
            }));


            stacksvis.draw({
                "dimensions": {
                    "row": rowlabels,
                    "column": columnlabels
                },
                "data": data
            });
        };

        loadTestData = function () {
            var rows = 5;
            var cols = 100;
            var doubledata = _.map(_.range(1, rows), function (i) {
                return _.map(_.range(1, cols), function (i) {
                    return (Math.floor(Math.random() * 7) + 4);
                });
            });

            var textdata = _.map(doubledata, function (doublerow) {
                return doublerow.join(",");
            });

            $("#text_data").val(textdata.join("\n"));
        };

        activateVisControls = function () {
            $(".draw-heatmap").click(drawHeatmap);
            $(".cluster-even-odd").click(function () {
                stacksvis.draw({
                    "dimensions": {
                        "clusterBy": "EVEN_or_ODD"
                    }
                });
            });
            $(".draw-heatmap").click(function () {
                $(".nav-tabs a:first").tab("show");
            });

            $(".slider-row-spacing").slider({ value: 0, min: 0, max: 100,
                slide: function (event, ui) {
                    stacksvis.spacing({ "row": ui.value });
                }
            });
            $(".slider-column-spacing").slider({ value: 0, min: 0, max: 100,
                slide: function (event, ui) {
                    stacksvis.spacing({ "column": ui.value });
                }
            });
            $(".slider-cluster-spacing").slider({ value: 0, min: 0, max: 100,
                slide: function (event, ui) {
                    stacksvis.spacing({ "cluster": ui.value });
                }
            });
            $(".slider-font-size").slider({ value: 8, min: 6, max: 24,
                slide: function (event, ui) {
                    stacksvis.options.label_fontsize = ui.value;
                    stacksvis.draw({});
                }
            });
        };

        enableDraggable = function () {
            var extractFn = function (x) {
                return $(x).html();
            };

            $(".s-row li").disableSelection();
            $(".s-row").sortable({
                "revert": true,
                "update": function () {
                    stacksvis.draw({ "dimensions": { "row": _.map($(".s-row li"), extractFn) } });
                }
            });

            $(".s-column li").disableSelection();
            $(".s-column").sortable({
                "revert": true,
                "update": function () {
                    stacksvis.draw({ "dimensions": { "column": _.map($(".s-column li"), extractFn) } });
                }
            });
        };
    </script>
</head>
<body>
<div class="container">
    <ul class="nav nav-tabs">
        <li class="active"><a href="#tab-vis" data-toggle="tab">Heatmap</a></li>
        <li><a href="#tab-data" data-toggle="tab">Input Data</a></li>
    </ul>
    <div class="tab-content">
        <div id="tab-vis" class="tab-pane active">
            <button class="btn btn-mini cluster-even-odd">Cluster Even/Odd</button>
            <button class="btn btn-mini" data-toggle="collapse" data-target="#enter-controls">Controls</button>

            <div id="enter-controls" class="collapse">
                <div class="well">
                    <h5>Row Spacing</h5>

                    <div class="slider-row-spacing"></div>

                    <h5>Column Spacing</h5>

                    <div class="slider-column-spacing"></div>

                    <h5>Cluster Spacing</h5>

                    <div class="slider-cluster-spacing"></div>

                    <h5>Font Size</h5>

                    <div class="slider-font-size"></div>
                </div>
            </div>
            <div class="row vis"></div>
        </div>
        <div id="tab-data" class="tab-pane well">
            <label for="text_data"><b>(csv-format)</b></label>
            <textarea id="text_data" rows="10" class="input-block-level"></textarea>
            <button class="btn btn-mini draw-heatmap">Re-draw</button>
        </div>
    </div>
</div>

</body>
</html>