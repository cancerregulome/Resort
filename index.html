<html>
<head>
    <link rel="stylesheet" type="text/css" href="http://informatics-apps.systemsbiology.net/bootstrap-2.0.4/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css"/>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Heatmap</title>

    <meta name="viewport" content="width=device-width">

    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.js"></script>
    <script type="text/javascript" src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://informatics-apps.systemsbiology.net/bootstrap-2.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script>

    <script type="text/javascript" src="js/stacksvis.js"></script>

    <link rel="stylesheet" type="text/css" href="css/stacksvis.css"/>

    <script type="text/javascript">
        $(document).ready(function () {
            activateVisControls();
            loadTestData();
            drawHeatmap();
        });
        var stacksvis;



        drawHeatmap = function () {
            var txt = $("#text_data").val();
            var data = d3.csv.parseRows(txt, function (row) {
                return _.map(row, parseFloat);
            });
            
            var rowlabels = _.map(_.range(0, data.length), function (i) {
                return "Row_" + i;
            });

            var columnlabels = _.range(0, _.first(data).length);

            rowlabels.push("EVEN_or_ODD");
            data.push(_.map(columnlabels, function (label, idx) {
                return (idx % 2 == 0) ? "EVEN" : "ODD";
            }));


            stacksvis = new Stacksvis({
                "colorscale" : colorbrewer['Set3'][8],
                "row_labels": rowlabels,
                "columns_by_cluster" : columnlabels,
                // "plot_width" : 400,
                "bar_width" : 5,
                "bar_height" : 20
            });
            $(".vis").on("render-dimensions", enableDraggable);

            var parentEl = d3.select('.vis').node();
            
            stacksvis.draw(parentEl, data);
            
        };

        loadTestData = function () {
            var rows = 20;
            var cols = 100;
            var doubledata = _.map(_.range(1, rows), function (i) {
                return _.map(_.range(1, cols), function (i) {
                    return (Math.floor(Math.random() * 7) + 4);
                });
            });

            var textdata = _.map(doubledata, function (doublerow) {
                return doublerow.join(",");
            });

            $("#text_data").val(textdata.join("\n"));
        };

        activateVisControls = function () {
            $(".draw-heatmap").click(drawHeatmap);
            $(".cluster-even-odd").click(function () {
                stacksvis.clusterByRows([2,3]);
            });
            $(".draw-heatmap").click(function () {
                $(".nav-tabs a:first").tab("show");
            });

            $(".slider-row-spacing").slider({ value: 0, min: 0, max: 100,
                slide: function (event, ui) {
                    stacksvis.spacing({ "row": ui.value });
                }
            });
            $(".slider-column-spacing").slider({ value: 0, min: 0, max: 100,
                slide: function (event, ui) {
                    stacksvis.spacing({ "column": ui.value });
                }
            });
            $(".slider-cluster-spacing").slider({ value: 0, min: 0, max: 100,
                slide: function (event, ui) {
                    stacksvis.spacing({ "cluster": ui.value });
                }
            });
            $(".slider-font-size").slider({ value: 8, min: 6, max: 24,
                slide: function (event, ui) {
                    stacksvis.options.label_fontsize = ui.value;
                    stacksvis.draw({});
                }
            });
        };

        enableDraggable = function () {
            var extractFn = function (x) {
                return $(x).html();
            };

            $(".s-row li").disableSelection();
            $(".s-row").sortable({
                "revert": true,
                "update": function () {
                    stacksvis.draw({ "dimensions": { "row": _.map($(".s-row li"), extractFn) } });
                }
            });

            $(".s-column li").disableSelection();
            $(".s-column").sortable({
                "revert": true,
                "update": function () {
                    stacksvis.draw({ "dimensions": { "column": _.map($(".s-column li"), extractFn) } });
                }
            });
        };
    </script>
</head>
<body>
<div class="container">
    <ul class="nav nav-tabs">
        <li class="active"><a href="#tab-vis" data-toggle="tab">Heatmap</a></li>
        <li><a href="#tab-data" data-toggle="tab">Input Data</a></li>
    </ul>
    <div class="tab-content">
        <div id="tab-vis" class="tab-pane active">
            <button class="btn btn-mini cluster-even-odd">Cluster Even/Odd</button>
            <button class="btn btn-mini" data-toggle="collapse" data-target="#enter-controls">Controls</button>

            <div id="enter-controls" class="collapse">
                <div class="well">
                    <h5>Row Spacing</h5>

                    <div class="slider-row-spacing"></div>

                    <h5>Column Spacing</h5>

                    <div class="slider-column-spacing"></div>

                    <h5>Cluster Spacing</h5>

                    <div class="slider-cluster-spacing"></div>

                    <h5>Font Size</h5>

                    <div class="slider-font-size"></div>
                </div>
            </div>
            <div class="row vis"></div>
        </div>
        <div id="tab-data" class="tab-pane well">
            <label for="text_data"><b>(csv-format)</b></label>
            <textarea id="text_data" rows="10" class="input-block-level"></textarea>
            <button class="btn btn-mini draw-heatmap">Re-draw</button>
        </div>
    </div>
</div>

</body>
</html>